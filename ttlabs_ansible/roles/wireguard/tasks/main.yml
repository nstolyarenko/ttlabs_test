---
- name: Install WireGuard
  ansible.builtin.package:
    name: wireguard
    state: present

- name: Create WireGuard directory on hosts
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    mode: '0700'
  become: true

- name: Ensure local WireGuard key directory exists
  delegate_to: localhost
  run_once: true
  ansible.builtin.file:
    path: "./keys"
    state: directory
    mode: '0700'

- name: Generate WireGuard private key (local, CI-safe)
  delegate_to: localhost
  ansible.builtin.shell: |
    umask 077
    openssl rand -base64 32 > ./keys/{{ inventory_hostname }}.key
  args:
    creates: "./keys/{{ inventory_hostname }}.key"

- name: Generate WireGuard public key (local, CI-safe)
  delegate_to: localhost
  ansible.builtin.shell: |
    base64 -d ./keys/{{ inventory_hostname }}.key | \
    openssl pkey -pubout -inform DER -outform DER 2>/dev/null | \
    base64 > ./keys/{{ inventory_hostname }}.pub
  args:
    creates: "./keys/{{ inventory_hostname }}.pub"

- name: Set host private key
  set_fact:
    wg_private_key: "{{ lookup('file', wg_key_dir + '/' + inventory_hostname + '.key') }}"
  vars:
    wg_key_dir: "./keys"

- name: Set host VPN IP
  set_fact:
    host_ip: "{{ vpn_network_cidr.split('.')[0:3] | join('.') }}.{{ host_index | int + 10 }}"

- name: Generate WireGuard config
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    mode: '0600'
  vars:
    wg_key_dir: "./keys"

- name: Enable and start WireGuard
  ansible.builtin.systemd:
    name: wg-quick@wg0
    enabled: yes
    state: started
