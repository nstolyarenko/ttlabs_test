
- name: Install WireGuard
  ansible.builtin.package:
    name: wireguard
    state: present
  become: true

- name: Create WireGuard directory on hosts
  ansible.builtin.file:
    path: /etc/wireguard
    state: directory
    mode: '0700'
  become: true

- name: Ensure local WireGuard key directory exists
  delegate_to: localhost
  run_once: true
  ansible.builtin.file:
    path: "{{ playbook_dir }}/keys"
    state: directory
    mode: '0700'

- name: Generate WireGuard private key (local, CI-safe)
  delegate_to: localhost
  ansible.builtin.shell: |
    umask 077
    openssl rand -base64 32 > "{{ playbook_dir }}/keys/{{ inventory_hostname }}.key"
  args:
    creates: "{{ playbook_dir }}/keys/{{ inventory_hostname }}.key"

- name: Generate WireGuard public key (local, CI-safe)
  delegate_to: localhost
  ansible.builtin.shell: |
    base64 -d "{{ playbook_dir }}/keys/{{ inventory_hostname }}.key" | \
    openssl pkey -pubout -inform DER -outform DER 2>/dev/null | \
    base64 > "{{ playbook_dir }}/keys/{{ inventory_hostname }}.pub"
  args:
    creates: "{{ playbook_dir }}/keys/{{ inventory_hostname }}.pub"


- name: Read private key from controller
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/keys/{{ inventory_hostname }}.key"
  delegate_to: localhost
  register: wg_private_key_raw

- name: Read public key from controller
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/keys/{{ inventory_hostname }}.pub"
  delegate_to: localhost
  register: wg_public_key_raw

- name: Set WireGuard key facts
  ansible.builtin.set_fact:
    wg_private_key: "{{ wg_private_key_raw.content | b64decode | trim }}"
    wg_public_key: "{{ wg_public_key_raw.content | b64decode | trim }}"

- name: Set host VPN IP
  set_fact:
    host_ip: "{{ vpn_network_cidr.split('.')[0:3] | join('.') }}.{{ host_index | int + 10 }}"

- name: Generate WireGuard config
  ansible.builtin.template:
    src: wg0.conf.j2
    dest: /etc/wireguard/wg0.conf
    mode: '0600'
  become: true

- name: Enable and start WireGuard
  ansible.builtin.systemd:
    name: wg-quick@wg0
    enabled: yes
    state: started
  become: true
